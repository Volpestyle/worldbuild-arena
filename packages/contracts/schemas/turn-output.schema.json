{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://worldbuild-arena.dev/schemas/turn-output.schema.json",
  "title": "TurnOutput",
  "type": "object",
  "additionalProperties": false,
  "required": ["speaker_role", "turn_type", "content"],
  "properties": {
    "speaker_role": {
      "type": "string",
      "enum": ["ARCHITECT", "LOREKEEPER", "CONTRARIAN", "SYNTHESIZER"]
    },
    "turn_type": {
      "type": "string",
      "enum": ["PROPOSAL", "OBJECTION", "RESPONSE", "RESOLUTION", "VOTE"]
    },
    "content": { "type": "string", "minLength": 1 },
    "canon_patch": { "$ref": "https://worldbuild-arena.dev/schemas/json-patch.schema.json" },
    "references": {
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "default": []
    },
    "vote": { "$ref": "#/$defs/vote" }
  },
  "allOf": [
    {
      "if": { "type": "object", "properties": { "turn_type": { "const": "VOTE" } }, "required": ["turn_type"] },
      "then": { "type": "object", "required": ["vote"], "properties": { "vote": {} } }
    },
    {
      "if": {
        "type": "object",
        "properties": {
          "turn_type": { "const": "VOTE" },
          "vote": { "type": "object", "properties": { "choice": { "const": "AMEND" } }, "required": ["choice"] }
        },
        "required": ["turn_type", "vote"]
      },
      "then": { "type": "object", "required": ["canon_patch"], "properties": { "canon_patch": {} } }
    }
  ],
  "$defs": {
    "vote": {
      "type": "object",
      "additionalProperties": false,
      "required": ["choice"],
      "properties": {
        "choice": { "type": "string", "enum": ["ACCEPT", "AMEND", "REJECT"] },
        "amendment_summary": { "type": "string", "minLength": 1 }
      },
      "allOf": [
        {
          "if": { "type": "object", "properties": { "choice": { "const": "AMEND" } }, "required": ["choice"] },
          "then": { "type": "object", "required": ["amendment_summary"], "properties": { "amendment_summary": {} } }
        }
      ]
    }
  }
}
